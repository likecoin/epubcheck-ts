# Copilot Instructions for epubcheck-ts

## Project Overview

**epubcheck-ts** is a TypeScript port of the Java-based [EPUBCheck](https://github.com/w3c/epubcheck) library for validating EPUB publications against EPUB 2.x and 3.x specifications. The project aims for 1:1 feature parity with the Java implementation while running cross-platform in Node.js 18+ and modern browsers with zero native dependencies.

**Current Status:** ~20% feature parity with Java EPUBCheck (see PROJECT_STATUS.md for detailed comparison)

**Key Technologies:**
- TypeScript 5.7+ with strict type checking (ESM-first with `.js` extensions)
- Node.js 18+ (tested on 18, 20, 22)
- Dependencies: `libxml2-wasm` (XML/schema validation), `fflate` (ZIP), `css-tree` (CSS), `fontoxpath` (XPath)
- Build: `tsup` (ESM + CJS), Test: `vitest`, Lint: `eslint` + `biome`

## Build & Validation Workflow

**CRITICAL: Always run commands in this exact order to avoid issues:**

### 1. Initial Setup (Required)
```bash
npm install  # Takes ~4s, installs 227 packages. MUST run before any other command.
```

### 2. Development Workflow
**CRITICAL: Commands must be run in this order:**

```bash
# 1. Build FIRST (required for typecheck to pass)
npm run build      # tsup builds ESM + CJS + DTS (takes ~2s)

# 2. Then run validation commands:
npm run lint       # ESLint - strict TypeScript rules (takes ~5s)
                   # NOTE: Currently has 59 errors in bin/epubcheck.ts (known issue)
npm run typecheck  # tsc --noEmit (takes ~2s)
                   # REQUIRES dist/ to exist - run build first!
npm test -- --run  # Vitest - 507 tests pass, 48 skipped (takes ~4s)

# Or run format + typecheck together (after build):
npm run check      # biome format + eslint + tsc --noEmit (takes ~8s)
```

**Why order matters:**
- `bin/epubcheck.ts` imports from `dist/index.js`, so build must run before typecheck
- Without build, typecheck fails with "Cannot find module '../dist/index.js'"

### 3. Common Commands
```bash
npm run dev          # Watch mode build (for development)
npm test             # Interactive test watch mode
npm run test:coverage # Coverage report (80% thresholds)
npm run lint:fix     # Auto-fix ESLint issues
npm run format       # Auto-fix Biome formatting (ALWAYS run before commit)
npm run clean        # Remove dist/ and coverage/ (use when build issues occur)
```

**Common Pitfalls:**
1. **Forgot to build**: If typecheck fails with "Cannot find module", run `npm run build` first
2. **Stale build**: If behavior doesn't match code changes, run `npm run clean && npm run build`
3. **Formatting issues**: Always run `npm run format` before committing
4. **Test failures**: Ensure you're running tests AFTER building with `npm run build`

### 4. Known Issues & Workarounds

- **Build order**: ALWAYS run `npm run build` before `npm run typecheck`. Typecheck will fail with module not found errors if dist/ doesn't exist.
- **Lint errors**: `bin/epubcheck.ts` has 59 ESLint errors related to `any` types. This is a known issue. Lint errors in src/ are not acceptable, but bin/ errors can be ignored temporarily.
- **Test count**: Tests currently show 507 passing, 48 skipped (not 82 pass, 1 skipped).
- **Clean build**: If you encounter issues, run `npm run clean` to remove dist/, then rebuild with `npm run build`.
- **Formatting**: Run `npm run format` to auto-fix Biome formatting issues before committing.
- **Test timeout**: Default is 10s. If tests timeout, check `vitest.config.ts`.

## CI/CD Pipeline

**GitHub Actions CI** (`.github/workflows/ci.yml`) runs on every push/PR:

1. Matrix build: Node.js 18, 20, 22 on Ubuntu
2. Steps: checkout → setup Node → `npm ci` → **build** → lint → typecheck → test
3. **Key differences from dev**:
   - CI uses `npm ci` (clean, faster, reproducible) vs `npm install` (dev)
   - CI runs build BEFORE lint/typecheck/test (correct order)
   - **CI will FAIL on lint step** due to 59 errors in bin/epubcheck.ts

To replicate CI locally:
```bash
rm -rf node_modules dist
npm ci                    # Clean install (takes ~2s, faster than npm install)
npm run build             # Build first!
npm run lint              # WILL FAIL with exit code 1 (59 errors)
npm run typecheck         # Requires build
npm test -- --run         # 507 tests pass
```

**Note**: CI currently fails on lint step. When making changes:
1. Focus on not adding NEW lint errors in src/
2. If you fix any of the 59 bin/ errors, that's a bonus
3. Your PR will need lint to pass - consider fixing bin/ errors or getting them excluded

## Project Architecture

### Directory Structure
```
src/
├── index.ts              # Public API exports (keep minimal)
├── checker.ts            # Main EpubCheck class & validation orchestration
├── types.ts              # Shared TypeScript interfaces
├── core/                 # Report generation, context management
├── ocf/                  # OCF Container (ZIP) validation (~30% complete)
│   ├── validator.ts      # Mimetype, container.xml, ZIP structure
│   └── zip.ts            # fflate-based ZIP reader
├── opf/                  # Package Document (OPF) validation (~35% complete)
│   ├── parser.ts         # OPF XML parsing
│   ├── validator.ts      # Metadata, manifest, spine, fallbacks
│   └── types.ts          # OPF-specific types
├── content/              # Content Document validation (~15% complete)
│   └── validator.ts      # XHTML/SVG validation (regex-based, TODO: DOM)
├── nav/                  # Navigation validation (~5% complete)
│   └── validator.ts      # EPUB 3 nav, NCX basic checks
├── schema/               # Schema validation (0% - stubs only)
│   ├── relaxng.ts        # RelaxNG via libxml2-wasm (TODO)
│   ├── xsd.ts            # XSD validation (TODO)
│   └── validator.ts      # Schema loading infrastructure
├── references/           # Cross-reference validation (partial)
│   ├── registry.ts       # Resource ID tracking
│   └── validator.ts      # Link target validation
├── css/                  # CSS validation (0% - parser available)
│   └── validator.ts      # css-tree integration (TODO)
└── messages/             # Error messages & i18n
    ├── message-id.ts     # Message ID enum (PKG-*, OPF-*, HTM-*, etc.)
    └── index.ts          # Message formatting
```

### Key Files to Know

- **Configuration:**
  - `package.json` - scripts, dependencies, exports
  - `tsconfig.json` - strict TypeScript settings, NodeNext module resolution
  - `tsup.config.ts` - build configuration (ESM + CJS + DTS)
  - `vitest.config.ts` - test configuration, 80% coverage thresholds
  - `eslint.config.js` - TypeScript ESLint rules (strict, explicit types)
  - `biome.json` - formatting rules (line width 100, single quotes)

- **Entry Points:**
  - `src/index.ts` - public API exports
  - `src/checker.ts` - main validation logic (see TODOs at lines 94, 97)

- **Testing:**
  - Tests co-located with source: `*.test.ts` (6 test files)
  - No integration tests or fixtures yet
  - Run specific test: `npm test -- src/ocf/validator.test.ts`

### Important Patterns

**TypeScript Conventions:**
```typescript
// ALWAYS use .js extensions for local imports (NodeNext resolution)
import type { ValidationMessage } from './types.js';  // ✓ Correct
import { Report } from './core/report.js';            // ✓ Correct
import { ValidationMessage } from './types';          // ✗ Wrong - missing .js

// Use type imports for types only (verbatimModuleSyntax)
import type { Foo } from './types.js';                // ✓ For types
import { bar } from './utils.js';                     // ✓ For values
```

**Message IDs:** Use same IDs as Java EPUBCheck for compatibility:
- Format: `PREFIX-NNN` (e.g., `PKG-006`, `OPF-030`, `HTM-001`)
- Prefixes: PKG (container), OPF (package doc), HTM (HTML), CSS, NAV, RSC (resources), ACC (accessibility)
- See `src/messages/message-id.ts` for full list (~165 defined, ~35 used)

**Test Structure:** Use Vitest with globals enabled:
```typescript
import { describe, it, expect } from 'vitest';

describe('ComponentName', () => {
  it('should do something specific', () => {
    // Arrange, Act, Assert
  });
});
```

## Areas Under Active Development

**TODO markers in codebase:**
- `src/checker.ts:94, 97` - Navigation and schema validation not implemented
- `src/ocf/validator.ts:147` - Need libxml2-wasm for proper XML parsing
- `src/schema/relaxng.ts:31, 72` - Schema loading from bundled schemas
- `src/references/validator.test.ts:100` - ID registration logic needs fixing

**High-priority missing features:**
1. Schema validation (RelaxNG, XSD, Schematron) - required for many validations
2. Full XML DOM parsing - currently using regex (error-prone)
3. Cross-reference validation - link targets, fragments, unused resources
4. CSS validation - parser available (css-tree), validation not implemented

## Making Changes

**Before coding:**
1. Review `AGENTS.md` for detailed coding guidelines
2. Check `PROJECT_STATUS.md` for feature completeness
3. Search for existing TODOs related to your work: `grep -r "TODO" src/`

**During development:**
1. Keep changes minimal - this is a port, not a rewrite
2. Preserve Java EPUBCheck message IDs and validation behavior
3. Use TypeScript idioms, don't directly translate Java patterns
4. Write co-located tests (`foo.ts` → `foo.test.ts`)
5. Avoid Node.js-specific APIs in core code (must run in browsers)

**Before committing:**
```bash
npm run build      # Build first!
npm run lint       # Currently has 59 errors in bin/ (acceptable)
                   # BUT: Your changes in src/ must not add new errors
npm run typecheck  # Must pass
npm test -- --run  # All tests must pass (507 passing, 48 skipped acceptable)
npm run format     # Auto-fix formatting issues
```

**Complete pre-commit validation:**
```bash
# Clean slate
npm run clean
rm -rf node_modules
npm ci

# Build and validate (CI order)
npm run build && \
npm run lint && \
npm run typecheck && \
npm test -- --run

# Check for uncommitted formatting changes
git diff --exit-code
```

**Validation Checklist:**
- [ ] TypeScript strict mode compliance (no `any`, explicit return types)
- [ ] ESM imports with `.js` extensions
- [ ] Type-only imports use `import type`
- [ ] Message IDs match Java EPUBCheck
- [ ] Tests added/updated
- [ ] No Node.js-specific APIs in src/ (except examples/)
- [ ] Biome formatting applied (`npm run format`)

## Quick Reference

**File Naming:** kebab-case (`message-id.ts`, `zip-reader.ts`)  
**Classes/Types:** PascalCase (`EpubCheck`, `ValidationMessage`)  
**Functions/vars:** camelCase (`validateContainer`, `errorCount`)  
**Constants:** UPPER_SNAKE_CASE (`DEFAULT_OPTIONS`, `MAX_ERRORS`)

**Dependencies versions (from package.json):**
- Node.js: >=18 (tested 18, 20, 22)
- TypeScript: 5.7.2
- Vitest: 2.1.8
- ESLint: 9.17.0
- Biome: 1.9.4

**Java EPUBCheck Reference:** The Java source being ported is described in AGENTS.md. The official Java implementation is at https://github.com/w3c/epubcheck

## Getting Help

- Check existing documentation: `README.md`, `CONTRIBUTING.md`, `AGENTS.md`, `PROJECT_STATUS.md`
- Search for similar code patterns in `src/`
- Look at test files for usage examples
- Review Java EPUBCheck source for validation logic reference (https://github.com/w3c/epubcheck)

**Prefer using these instructions over exploration when the information is sufficient for your task.** Only search/explore if information here is incomplete or incorrect.

## Troubleshooting

### Build Failures

**Problem**: `Cannot find module '../dist/index.js'`  
**Solution**: Run `npm run build` before `npm run typecheck`

**Problem**: Stale build output, changes not reflected  
**Solution**: 
```bash
npm run clean
npm run build
```

**Problem**: `npm ci` vs `npm install` differences  
**Solution**: 
- Use `npm install` for development (faster incremental updates)
- Use `npm ci` to replicate CI behavior (clean install from lockfile)
- `npm ci` requires existing package-lock.json

### Test Failures

**Problem**: Tests fail after code changes  
**Solution**: Rebuild before testing:
```bash
npm run build
npm test -- --run
```

**Problem**: Tests timeout  
**Solution**: Increase timeout in `vitest.config.ts` (currently 10s)

### Lint Failures

**Problem**: CI fails with 59 lint errors in bin/epubcheck.ts  
**Solution**: 
- This is a known issue with the CLI wrapper file
- Your changes in src/ must not add new lint errors
- To pass CI, either:
  1. Fix the bin/epubcheck.ts type safety issues, OR
  2. Add bin/ to eslint ignores in eslint.config.js (temporary workaround)

**To check only your changes for lint errors:**
```bash
# Lint only src/ directory
npx eslint src/
```

### Common Mistakes to Avoid

1. **Running typecheck before build** - Always build first
2. **Forgetting to format** - Run `npm run format` before every commit
3. **Not cleaning before full test** - Use `npm run clean` when in doubt
4. **Testing without building** - Some tests may pass but behavior won't match if dist/ is stale
